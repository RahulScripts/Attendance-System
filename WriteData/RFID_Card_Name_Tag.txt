#include <SPI.h>
#include <MFRC522.h>

constexpr uint8_t RST_PIN = D3;  // ğŸ”„ Reset pin for RFID
constexpr uint8_t SS_PIN = D4;   // ğŸ›  Slave Select pin for RFID

MFRC522 mfrc522(SS_PIN, RST_PIN);  // ğŸ“¡ Create MFRC522 instance
MFRC522::MIFARE_Key key;           // ğŸ” Key for authentication

int blockNum = 4;  // ğŸ’¾ Block to store data (16 bytes max)

byte readBlockData[18];  // ğŸ“¥ Buffer for reading data (18 bytes needed)
byte bufferLen = 18;
MFRC522::StatusCode status;  // ğŸš¦ Status code for RFID operations

// âœï¸ Function to write data to RFID card
void WriteDataToBlock(int blockNum, String data) {
byte blockData[16];  
memset(blockData, 0, sizeof(blockData));  // ğŸ§¹ Clear the buffer
data.getBytes(blockData, 16);  // ğŸ”£ Convert string to byte array

// ğŸ” Authenticate before writing
status = mfrc522.PCD_Authenticate(MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid));
if (status != MFRC522::STATUS_OK) {
Serial.print("âŒ Authentication failed (Write): ");
Serial.println(mfrc522.GetStatusCodeName(status));
return;
}

// ğŸ’¾ Write data to block
status = mfrc522.MIFARE_Write(blockNum, blockData, 16);
if (status != MFRC522::STATUS_OK) {
Serial.print("âŒ Writing failed: ");
Serial.println(mfrc522.GetStatusCodeName(status));
return;
}
    
Serial.println("âœ… Data written successfully!");
}

// ğŸ“– Function to read data from RFID card
void ReadDataFromBlock(int blockNum) {
// ğŸ” Authenticate before reading
status = mfrc522.PCD_Authenticate(MFRC522::PICC_CMD_MF_AUTH_KEY_A, blockNum, &key, &(mfrc522.uid));
if (status != MFRC522::STATUS_OK) {
Serial.print("âŒ Authentication failed (Read) on block ");
Serial.print(blockNum);
Serial.print(": ");
Serial.println(mfrc522.GetStatusCodeName(status));
return;
}

// ğŸ“¥ Read data from block
status = mfrc522.MIFARE_Read(blockNum, readBlockData, &bufferLen);
if (status != MFRC522::STATUS_OK) {
Serial.print("âŒ Reading failed on block ");
Serial.print(blockNum);
Serial.print(": ");
Serial.println(mfrc522.GetStatusCodeName(status));
return;
}

// ğŸ”£ Convert bytes to string and clean up the data
String cardData = String((char*)readBlockData);
cardData.trim();

Serial.print("ğŸ“„ Card Data: ");
Serial.println(cardData);
}

// ğŸš€ Setup function
void setup() {
Serial.begin(115200);
SPI.begin();          // ğŸ›  Initialize SPI communication
mfrc522.PCD_Init();   // ğŸš€ Initialize RFID reader
Serial.println("ğŸ”„ Ready to scan RFID Tag...");

// ğŸ” Set default authentication key (0xFF for most cards)
for (byte i = 0; i < 6; i++) {
key.keyByte[i] = 0xFF;
}
}

// ğŸ”„ Main loop function
void loop() {

// ğŸš« Return if no card is present or failed to read
if (!mfrc522.PICC_IsNewCardPresent() || !mfrc522.PICC_ReadCardSerial()) {
return;
}

Serial.println("\nğŸ´ **Card Detected**");

// ğŸ”‘ Display Card UID
Serial.print(F("ğŸ”¹ UID: "));
for (byte i = 0; i < mfrc522.uid.size; i++) {
Serial.print(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " ");
Serial.print(mfrc522.uid.uidByte[i], HEX);
}
Serial.println();

// ğŸ“Œ Display Card Type
Serial.print(F("ğŸ”¸ Type: "));
Serial.println(mfrc522.PICC_GetTypeName(mfrc522.PICC_GetType(mfrc522.uid.sak)));

// âœï¸ Write data to card
Serial.println("ğŸ“ Writing data to card...");
WriteDataToBlock(blockNum, "13-JASPREET SINGH");  // Example data

// ğŸ“– Read data back from card
Serial.println("ğŸ“– Reading data from card...");
ReadDataFromBlock(blockNum);

mfrc522.PICC_HaltA();    // âœ‹ Halt card
mfrc522.PCD_StopCrypto1();  // ğŸ›‘ Stop encryption
delay(2000);  // â± Wait for 2 seconds before next loop
}
